{% extends "base.html" %}

{% block title %}Чат с {{ other_user.first_name }} - Линка{% endblock %}

{% block content %}
<div class="chat-layout">
    <!-- Заголовок чата -->
    <div class="chat-header">
        <a href="{{ url_for('messages') }}" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <a href="{{ url_for('profile', username=other_user.username) }}" class="chat-user-info">
            <div class="chat-header-avatar">
                {% if other_user.avatar %}
                    {% set avatar_filename = other_user.avatar.split('/')[-1] if '/' in other_user.avatar else other_user.avatar %}
                    <img src="{{ url_for('uploaded_file', filename=avatar_filename) }}" alt="{{ other_user.username }}">
                {% else %}
                    {{ other_user.username[0].upper() }}
                {% endif %}
            </div>
            <div class="chat-header-text">
                <div class="chat-header-name">{{ other_user.first_name }} {{ other_user.last_name }}</div>
                <div class="chat-header-username">@{{ other_user.username }}</div>
            </div>
        </a>
    </div>

    <!-- Область сообщений -->
    <div class="chat-messages" id="chatMessages">
        {% for message in messages %}
        <div class="message-item {% if message.sender_id == session.user_id %}message-own{% else %}message-other{% endif %}">
            {% if message.sender_id != session.user_id %}
            <div class="message-avatar">
                {% if other_user.avatar %}
                    {% set avatar_filename = other_user.avatar.split('/')[-1] if '/' in other_user.avatar else other_user.avatar %}
                    <img src="{{ url_for('uploaded_file', filename=avatar_filename) }}" alt="{{ other_user.username }}">
                {% else %}
                    {{ other_user.username[0].upper() }}
                {% endif %}
            </div>
            {% endif %}
            <div class="message-content">
                <div class="message-bubble">
                    <div class="message-text">{{ message.content }}</div>
                    <div class="message-time">{{ message.created_at.strftime('%H:%M') }}</div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Форма отправки сообщения -->
    <div class="chat-input-area">
        <form id="messageForm" class="chat-form">
            <input type="hidden" id="recipientUsername" value="{{ other_user.username }}">
            <div class="chat-input-wrapper">
                <textarea id="messageInput" class="chat-input" placeholder="Написать сообщение..." rows="1"></textarea>
                <button type="submit" class="send-btn" id="sendBtn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .chat-layout {
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        background: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        overflow: hidden;
    }

    .chat-header {
        background: #ffffff;
        border-bottom: 1px solid rgba(0, 0, 0, 0.08);
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        flex-shrink: 0;
    }

    .back-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.04);
        color: #1A1A1A;
        text-decoration: none;
        transition: all 0.2s ease;
    }

    .back-btn:hover {
        background: rgba(0, 122, 255, 0.1);
        color: #007AFF;
        transform: scale(1.05);
    }

    .chat-user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
        text-decoration: none;
        color: #1A1A1A;
        flex: 1;
    }

    .chat-header-avatar {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007AFF, #66A3FF);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 1.2rem;
        flex-shrink: 0;
        overflow: hidden;
    }

    .chat-header-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .chat-header-text {
        flex: 1;
        min-width: 0;
    }

    .chat-header-name {
        font-weight: 600;
        font-size: 1.1rem;
        margin-bottom: 0.25rem;
    }

    .chat-header-username {
        font-size: 0.9rem;
        color: rgba(26, 26, 26, 0.6);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        background: #F5F7FA;
    }

    .message-item {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
        max-width: 70%;
    }

    .message-own {
        align-self: flex-end;
        margin-left: auto;
        flex-direction: row-reverse;
    }

    .message-other {
        align-self: flex-start;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: linear-gradient(45deg, #007AFF, #66A3FF);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 0.9rem;
        flex-shrink: 0;
        overflow: hidden;
    }

    .message-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 50%;
    }

    .message-content {
        flex: 1;
        min-width: 0;
    }

    .message-bubble {
        background: #ffffff;
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        padding: 0.75rem 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .message-own .message-bubble {
        background: #007AFF;
        border-color: #007AFF;
        color: white;
    }

    .message-text {
        color: #1A1A1A;
        line-height: 1.5;
        word-wrap: break-word;
        margin-bottom: 0.25rem;
    }

    .message-own .message-text {
        color: white;
    }

    .message-time {
        font-size: 0.75rem;
        color: rgba(26, 26, 26, 0.5);
        text-align: right;
    }

    .message-own .message-time {
        color: rgba(255, 255, 255, 0.8);
    }

    .chat-input-area {
        background: #ffffff;
        border-top: 1px solid rgba(0, 0, 0, 0.08);
        padding: 1rem 1.5rem;
        flex-shrink: 0;
    }

    .chat-form {
        width: 100%;
    }

    .chat-input-wrapper {
        display: flex;
        align-items: flex-end;
        gap: 0.75rem;
        background: rgba(0, 0, 0, 0.04);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 24px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
    }

    .chat-input-wrapper:focus-within {
        background: #ffffff;
        border-color: #007AFF;
        box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .chat-input {
        flex: 1;
        border: none;
        outline: none;
        background: transparent;
        font-size: 1rem;
        color: #1A1A1A;
        resize: none;
        max-height: 120px;
        font-family: inherit;
        line-height: 1.5;
    }

    .chat-input::placeholder {
        color: rgba(26, 26, 26, 0.5);
    }

    .send-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #007AFF;
        border: none;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        flex-shrink: 0;
        box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
    }

    .send-btn:hover {
        background: #005FCC;
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.4);
    }

    .send-btn:disabled {
        background: rgba(0, 122, 255, 0.5);
        cursor: not-allowed;
        transform: none;
    }

    /* Скроллбар для сообщений */
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3);
    }

    @media (max-width: 768px) {
        .chat-layout {
            height: calc(100vh - 140px);
            border-radius: 0;
            margin: 0;
        }

        .message-item {
            max-width: 85%;
        }

        .chat-header {
            padding: 1rem;
        }

        .chat-messages {
            padding: 1rem;
        }

        .chat-input-area {
            padding: 1rem;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const recipientUsername = document.getElementById('recipientUsername').value;
        
        // Подключение к SocketIO с передачей сессионной информации
        const socket = io({
            withCredentials: true,
            transports: ['websocket', 'polling']
        });
        
        // Сохраняем информацию об аватаре получателя для динамического отображения
        {% if other_user.avatar %}
            {% set avatar_filename = other_user.avatar.split('/')[-1] if '/' in other_user.avatar else other_user.avatar %}
            const otherUserAvatar = '{{ url_for("uploaded_file", filename=avatar_filename) }}';
        {% else %}
            const otherUserAvatar = null;
        {% endif %}
        const otherUserInitial = '{{ other_user.username[0].upper() }}';

        // Автоматическое изменение размера textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });

        // Обработка подключения к SocketIO
        socket.on('connect', function() {
            console.log('Подключено к серверу SocketIO');
            // Сразу пытаемся присоединиться к чату после подключения
            setTimeout(function() {
                socket.emit('join_chat', {username: recipientUsername});
                console.log('Отправлен запрос на присоединение к чату с', recipientUsername);
            }, 100);
        });

        socket.on('connected', function(data) {
            console.log('Подтверждение подключения от сервера:', data);
            // Дополнительно присоединяемся к чату после подтверждения
            if (data && data.user_id) {
                socket.emit('join_chat', {username: recipientUsername});
            }
        });

        socket.on('joined_chat', function(data) {
            console.log('Успешно присоединились к чату:', data);
        });
        
        socket.on('error', function(data) {
            console.error('Ошибка SocketIO:', data);
            if (data && data.message) {
                console.error('Сообщение об ошибке:', data.message);
            }
        });

        // Обработка новых сообщений в реальном времени
        socket.on('new_message', function(data) {
            console.log('Получено новое сообщение:', data);
            // Проверяем, не наше ли это сообщение (чтобы не дублировать)
            const isOwn = data.sender_username === '{{ session.username }}';
            // Показываем только чужие сообщения здесь, свои придут через message_sent
            if (!isOwn) {
                addMessageToChat(data.content, false, data.created_at, data);
            }
        });

        // Подтверждение отправки собственного сообщения
        socket.on('message_sent', function(data) {
            console.log('Сообщение отправлено:', data);
            // Добавляем собственное сообщение в чат
            if (data.is_own && data.content) {
                addMessageToChat(data.content, true, data.created_at, {message_id: data.message_id});
            }
        });

        // Обработка ошибок
        socket.on('error', function(data) {
            console.error('Ошибка SocketIO:', data);
            alert(data.message || 'Произошла ошибка');
        });

        // Отправка сообщения через SocketIO (приоритет) или fallback на HTTP
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const content = messageInput.value.trim();
            if (!content) return;

            // Отключаем кнопку
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            // Пытаемся отправить через SocketIO
            if (socket.connected) {
                // Очищаем поле ввода сразу для лучшего UX
                messageInput.value = '';
                messageInput.style.height = 'auto';
                
                socket.emit('send_message', {
                    username: recipientUsername,
                    content: content
                });
                
                // Сообщение будет добавлено через событие 'message_sent' от сервера
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
            } else {
                // Fallback на HTTP запрос
                fetch('/api/messages/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: recipientUsername,
                        content: content
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messageInput.value = '';
                        messageInput.style.height = 'auto';
                        addMessageToChat(content, true, data.created_at);
                        scrollToBottom();
                    } else {
                        alert(data.error || 'Ошибка при отправке сообщения');
                    }
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Ошибка при отправке сообщения');
                })
                .finally(() => {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                });
            }
        });

        // Добавление сообщения в чат
        function addMessageToChat(content, isOwn, time, messageData) {
            // Проверяем, не добавлено ли уже это сообщение
            const existingMessage = document.querySelector(`[data-message-id="${messageData?.message_id || ''}"]`);
            if (existingMessage) {
                return; // Сообщение уже добавлено
            }

            const messageItem = document.createElement('div');
            messageItem.className = `message-item ${isOwn ? 'message-own' : 'message-other'}`;
            if (messageData && messageData.message_id) {
                messageItem.setAttribute('data-message-id', messageData.message_id);
            }
            
            if (!isOwn) {
                let avatarHtml = '';
                if (messageData && messageData.sender_avatar) {
                    avatarHtml = `<img src="${escapeHtml(messageData.sender_avatar)}" alt="${escapeHtml(messageData.sender_username || '')}">`;
                } else if (otherUserAvatar) {
                    avatarHtml = `<img src="${escapeHtml(otherUserAvatar)}" alt="${escapeHtml('{{ other_user.username }}')}">`;
                } else {
                    avatarHtml = escapeHtml(otherUserInitial);
                }

                messageItem.innerHTML = `
                    <div class="message-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(content)}</div>
                            <div class="message-time">${time || new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                `;
            } else {
                messageItem.innerHTML = `
                    <div class="message-content">
                        <div class="message-bubble">
                            <div class="message-text">${escapeHtml(content)}</div>
                            <div class="message-time">${time || new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                `;
            }
            
            chatMessages.appendChild(messageItem);
            scrollToBottom();
            
            // Помечаем сообщение как прочитанное (если это входящее сообщение)
            if (!isOwn && messageData && messageData.message_id) {
                // Отправляем на сервер информацию о прочтении
                socket.emit('mark_read', {message_id: messageData.message_id});
            }
        }

        // Экранирование HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Прокрутка вниз
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Обработка отключения при закрытии страницы
        window.addEventListener('beforeunload', function() {
            socket.emit('leave_chat', {username: recipientUsername});
            socket.disconnect();
        });

        // Инициализация
        scrollToBottom();
    });
</script>
{% endblock %}

